# 603 AMS Gateway –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è - –í–´–ü–û–õ–ù–ï–ù–û ‚úÖ

## –ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ
–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –ø–æ–ª–Ω–∞—è —Ä–µ—Å—Ç—Ä—É–∫—Ç—É—Ä–∏–∑–∞—Ü–∏—è AMS –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ –∏–∑ –º–æ–Ω–æ–ª–∏—Ç–Ω–æ–≥–æ `AMSRabbitMQClient` –≤ –ø—Ä–∞–≤–∏–ª—å–Ω—É—é gateway –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É –ø–æ –æ–±—Ä–∞–∑—Ü—É `comfyUI2`/`renderFarm`. –ó–∞–≥–ª—É—à–∫–∏ –∑–∞–º–µ–Ω–µ–Ω—ã –Ω–∞ —Ä–∞–±–æ—á—É—é —Å–µ—Ä–≤–µ—Ä–Ω—É—é –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é —á–µ—Ä–µ–∑ RabbitMQ —Å per-request exclusive –æ—á–µ—Ä–µ–¥—è–º–∏.

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è

### –î–æ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞ (–ø—Ä–æ–±–ª–µ–º—ã):
- ‚ùå –ú–æ–Ω–æ–ª–∏—Ç–Ω—ã–π `AMSRabbitMQClient` –≤ `src/server/services/ams/`
- ‚ùå –û–±—â–∞—è –æ—á–µ—Ä–µ–¥—å –æ—Ç–≤–µ—Ç–æ–≤ —Å –≥–æ–Ω–∫–∞–º–∏ –∏ –∑–∞–ª–∏–ø–∞–Ω–∏–µ–º —Å–ª—É—à–∞—Ç–µ–ª–µ–π
- ‚ùå AMQP –ª–æ–≥–∏–∫–∞ —Ä–∞–∑–º–∞–∑–∞–Ω–∞ –ø–æ ResourceStorage
- ‚ùå –ó–∞–≥–ª—É—à–∫–∏ –≤–º–µ—Å—Ç–æ —Ä–µ–∞–ª—å–Ω–æ–π –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏
- ‚ùå –¢–∏–ø—ã –Ω–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—Ç schema-first –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ

### –ü–æ—Å–ª–µ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞ (—Ä–µ—à–µ–Ω–∏–µ):
- ‚úÖ –ß–∏—Å—Ç–∞—è gateway –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –≤ `src/server/gateways/ams/`
- ‚úÖ Per-request exclusive –æ—á–µ—Ä–µ–¥–∏ —Å –∞–≤—Ç–æ–æ—á–∏—Å—Ç–∫–æ–π
- ‚úÖ ResourceStorage –Ω–µ –∑–Ω–∞–µ—Ç –ø—Ä–æ AMQP - —Ç–æ–ª—å–∫–æ gateway API
- ‚úÖ –†–∞–±–æ—á–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π –∫–æ—Ä—Ä–µ–ª—è—Ü–∏–µ–π
- ‚úÖ Schema-first —Å –≥–µ–Ω–µ—Ä–∞—Ü–∏–µ–π —Ç–∏–ø–æ–≤ –∏ AJV –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π

## –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

### 1. –°—Ö–µ–º—ã –∏ —Ç–∏–ø–∏–∑–∞—Ü–∏—è ‚úÖ

**–°–æ–∑–¥–∞–Ω–æ:**
- `documentation/api/schemas/remote/ams/request.yaml` - —Å—Ö–µ–º–∞ –∑–∞–ø—Ä–æ—Å–æ–≤ AMS
- `documentation/api/schemas/remote/ams/response.yaml` - —Å—Ö–µ–º–∞ –æ—Ç–≤–µ—Ç–æ–≤ AMS
- `src/server/tools/build-api/types/exports/ams.yaml` - –º–∞–ø–ø–∏–Ω–≥ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ç–∏–ø–æ–≤
- `src/server/tools/build-api/exportSchemas/exports/ams.yaml` - –º–∞–ø–ø–∏–Ω–≥ –¥–ª—è AJV —Å—Ö–µ–º

**–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω—ã:**
- `src/types/gateways/ams/request.ts` - TypeScript —Ç–∏–ø—ã –∑–∞–ø—Ä–æ—Å–æ–≤
- `src/types/gateways/ams/response.ts` - TypeScript —Ç–∏–ø—ã –æ—Ç–≤–µ—Ç–æ–≤  
- `src/jsonSchemas/gateways/ams/request.ts` - AJV —Å—Ö–µ–º—ã –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –∑–∞–ø—Ä–æ—Å–æ–≤
- `src/jsonSchemas/gateways/ams/response.ts` - AJV —Å—Ö–µ–º—ã –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –æ—Ç–≤–µ—Ç–æ–≤

**–ó–∞—á–µ–º:** Schema-first –ø–æ–¥—Ö–æ–¥ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å —Ç–∏–ø–æ–≤ –º–µ–∂–¥—É compile-time –∏ runtime –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π.

### 2. Gateway —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ ‚úÖ

**–°–æ–∑–¥–∞–Ω–æ:**
```
src/server/gateways/ams/
‚îú‚îÄ‚îÄ internal/
‚îÇ   ‚îî‚îÄ‚îÄ rpc.ts                    # –ü—Ä–∏–≤–∞—Ç–Ω—ã–π RPC —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç
‚îú‚îÄ‚îÄ request/
‚îÇ   ‚îî‚îÄ‚îÄ requestHandler.ts         # –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –≤–∞–ª–∏–¥–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤
‚îú‚îÄ‚îÄ response/
‚îÇ   ‚îú‚îÄ‚îÄ parseResultMessage.ts     # –ü–∞—Ä—Å–∏–Ω–≥ –∏ –≤–∞–ª–∏–¥–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–æ–≤
‚îÇ   ‚îî‚îÄ‚îÄ resultWaiter.ts           # –û–±–µ—Ä—Ç–∫–∞ RPC + –ø–∞—Ä—Å–∏–Ω–≥
‚îú‚îÄ‚îÄ types/
‚îÇ   ‚îî‚îÄ‚îÄ index.ts                  # –ü–µ—Ä–µ—ç–∫—Å–ø–æ—Ä—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Ç–∏–ø–æ–≤
‚îî‚îÄ‚îÄ index.ts                      # –ü—É–±–ª–∏—á–Ω—ã–π API gateway
```

**–ó–∞—á–µ–º:** –ß–µ—Ç–∫–æ–µ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏, —Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ –ø—Ä–∏–Ω—Ü–∏–ø–∞–º SOLID, —É–ø—Ä–æ—â–µ–Ω–∏–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è.

### 3. RPC —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç (internal/rpc.ts) ‚úÖ

**–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ:**
- `AMSRPCTransport` class —Å lazy –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–µ–π
- Per-request exclusive –æ—á–µ—Ä–µ–¥–∏ (`exclusive: true, autoDelete: true`)
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –¥–≤—É—Ö —Ä–µ–∂–∏–º–æ–≤ –æ—Ç–≤–µ—Ç–∞:
  - –í–∞—Ä–∏–∞–Ω—Ç A: `replyTo: { queue: <exclusive-queue> }`
  - –í–∞—Ä–∏–∞–Ω—Ç B: `replyTo: { exchangeName: <exchange>, routingKey: <routing-key> }`
- –ö–æ—Ä—Ä–µ–ª—è—Ü–∏—è –ø–æ `requestId` –≤ JSON payload
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ —Ä–µ—Å—É—Ä—Å–æ–≤ (timeout + error handling)
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `getDefaultChannel()` –±–µ–∑ —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤—ã—Ö –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π

**–ó–∞—á–µ–º:** –ò–∑–±–µ–∂–∞—Ç—å –≥–æ–Ω–∫–∏ –∏ –∑–∞–ª–∏–ø–∞–Ω–∏–µ –æ–±—â–∏—Ö –æ—á–µ—Ä–µ–¥–µ–π, –æ–±–µ—Å–ø–µ—á–∏—Ç—å –∏–∑–æ–ª—è—Ü–∏—é –∑–∞–ø—Ä–æ—Å–æ–≤, –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é –æ—á–∏—Å—Ç–∫—É —Ä–µ—Å—É—Ä—Å–æ–≤.

### 4. Request Handler (request/requestHandler.ts) ‚úÖ

**–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ:**
- –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ AMS payload —Å–æ–≥–ª–∞—Å–Ω–æ —Å—Ö–µ–º–µ: `type: 'searchAssets'`, `requestId`, `replyTo`, `payload`, `context`
- AJV –≤–∞–ª–∏–¥–∞—Ü–∏—è –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ (`tenantId`, `userEmail`) –∏–∑ `OperationServices.requestContext`
- –î–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è `replyTo` –≤ RPC —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç

**–ó–∞—á–µ–º:** –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è, –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ payload, –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –º–Ω–æ–≥–æ—Ç–µ–Ω–∞–Ω—Ç–Ω–æ—Å—Ç–∏.

### 5. Response Parser (response/parseResultMessage.ts) ‚úÖ

**–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ:**
- AJV –≤–∞–ª–∏–¥–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–æ–≤ –æ—Ç AMS
- –ë–∏–∑–Ω–µ—Å-–≤–∞–ª–∏–¥–∞—Ü–∏—è: `success=true` —Ç—Ä–µ–±—É–µ—Ç `asset`, –ø—Ä–æ–≤–µ—Ä–∫–∞ `variations[]`
- Type guards: `isAMSSuccessResponse()`, `isAMSErrorResponse()`
- –î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫ –≤–∞–ª–∏–¥–∞—Ü–∏–∏

**–ó–∞—á–µ–º:** –ì–∞—Ä–∞–Ω—Ç–∏—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç–∏ –¥–∞–Ω–Ω—ã—Ö, —Ä–∞–Ω–Ω–µ–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏.

### 6. Result Waiter (response/resultWaiter.ts) ‚úÖ

**–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ:**
- –û–±–µ—Ä—Ç–∫–∞ –Ω–∞–¥ RPC —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–æ–º + –ø–∞—Ä—Å–∏–Ω–≥–æ–º –æ—Ç–≤–µ—Ç–æ–≤
- Singleton pattern –¥–ª—è RPC —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞ (lazy –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è)
- –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏—Ö –æ—à–∏–±–æ–∫ –≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –∏—Å–∫–ª—é—á–µ–Ω–∏—è
- –ü–æ–¥—Ä–æ–±–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —É—Å–ø–µ—à–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π

**–ó–∞—á–µ–º:** –£–ø—Ä–æ—â–µ–Ω–∏–µ API –¥–ª—è –≤–Ω–µ—à–Ω–∏—Ö –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª–µ–π, —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫.

### 7. –ü—É–±–ª–∏—á–Ω—ã–π API (index.ts) ‚úÖ

**–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ:**
- `requestAssetById(assetId, context?)` - –∑–∞–ø—Ä–æ—Å asset –∏–∑ AMS
- `selectVariation(asset, options)` - –≤—ã–±–æ—Ä –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ–π –≤–∞—Ä–∏–∞—Ü–∏–∏ –ø–æ –∫—Ä–∏—Ç–µ—Ä–∏—è–º:
  - –î–ª—è `image`: –±–ª–∏–∂–∞–π—à–∞—è –ø–æ –≤—ã—Å–æ—Ç–µ –∫ `round(1080 * scalingFactor)`
  - –î–ª—è `video` (preview): MP4 —Å –±–ª–∏–∂–∞–π—à–µ–π –≤—ã—Å–æ—Ç–æ–π
  - –î–ª—è `video` (order + preferProRes): ProRes ‚Üí fallback MP4
- `downloadVariationBuffer(url, timeout?)` - HTTP —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ axios
- –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ –≤—ã–±–æ—Ä–∞ –≤–∞—Ä–∏–∞—Ü–∏–π —Å –¥–µ—Ç–∞–ª—å–Ω–æ–π –ª–æ–≥–∏–∫–æ–π –≤—ã—Å–æ—Ç—ã/–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤

**–ó–∞—á–µ–º:** –ß–∏—Å—Ç—ã–π API –¥–ª—è ResourceStorage, –∏–Ω–∫–∞–ø—Å—É–ª—è—Ü–∏—è —Å–ª–æ–∂–Ω–æ–π –ª–æ–≥–∏–∫–∏ –≤—ã–±–æ—Ä–∞ —Ñ–æ—Ä–º–∞—Ç–æ–≤.

### 8. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ ResourceStorage ‚úÖ

**–ò–∑–º–µ–Ω–µ–Ω–æ:**
- `getAMSResourceViaRabbitMQ()` –ø–µ—Ä–µ–ø–∏—Å–∞–Ω —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Å—Ç–∞—Ä–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞ –Ω–∞ gateway API
- –£–¥–∞–ª–µ–Ω—ã —Ñ—É–Ω–∫—Ü–∏–∏ `selectAssetVariation()`, `selectImageVariation()`, `selectVideoVariation()` (–ø–µ—Ä–µ–Ω–µ—Å–µ–Ω—ã –≤ gateway)
- –£–±—Ä–∞–Ω –∏–º–ø–æ—Ä—Ç `require('../../mq/listeners/ams')` –∏ —Ñ—É–Ω–∫—Ü–∏—è `getAMSClient()`
- –õ–æ–≥–∏–∫–∞: gateway.requestAssetById ‚Üí gateway.selectVariation ‚Üí gateway.downloadVariationBuffer ‚Üí ensureImageProperties

**–ó–∞—á–µ–º:** –ü–æ–ª–Ω–∞—è –∏–∑–æ–ª—è—Ü–∏—è –æ—Ç AMQP –¥–µ—Ç–∞–ª–µ–π, —Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ –ø—Ä–∏–Ω—Ü–∏–ø—É –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–æ–π –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏.

### 9. –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è ‚úÖ

**–î–æ–±–∞–≤–ª–µ–Ω–æ:**
- `Config.ts`: –ø–æ–ª–µ `ams.responseExchange?: string | null`
- `environment.ts`: —á—Ç–µ–Ω–∏–µ `ams.responseExchange` –∫–∞–∫ –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–≥–æ
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –æ–±–æ–∏—Ö –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ —á–µ—Ä–µ–∑ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é

**–ó–∞—á–µ–º:** –ì–∏–±–∫–æ—Å—Ç—å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å —Ä–∞–∑–Ω—ã–º–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è–º–∏ AMS (Freya).

### 10. –£–¥–∞–ª–µ–Ω–∏–µ legacy –∫–æ–¥–∞ ‚úÖ

**–£–¥–∞–ª–µ–Ω–æ:**
- `src/server/services/ams/rabbitMQClient.ts` (–º–æ–Ω–æ–ª–∏—Ç–Ω—ã–π –∫–ª–∏–µ–Ω—Ç)
- `src/server/mq/listeners/ams.ts` (–≥–ª–æ–±–∞–ª—å–Ω—ã–π listener)
- `src/server/mq/index.ts` - —É–±—Ä–∞–Ω–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è AMS –∫–ª–∏–µ–Ω—Ç–∞
- `test/unit/server/services/ams/rabbitMQClient.test.ts`
- `test/unit/server/services/resources/storage.ams.test.ts`
- `test/unit/server/operations/loadResource.test.ts`
- `test/unit/server/operations/selectFrameFromVideo.test.ts`

**–ó–∞—á–µ–º:** –ò–∑–±–µ–∂–∞—Ç—å confusion, –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å —á–∏—Å—Ç–æ—Ç—É –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã, —É–±—Ä–∞—Ç—å –º–µ—Ä—Ç–≤—ã–π –∫–æ–¥.

## –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã –Ω–∞–π–¥–µ–Ω—ã –∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã üö®

### –ü—Ä–æ–±–ª–µ–º–∞ #1: –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ replyTo
**–ü—Ä–æ–±–ª–µ–º–∞:** RequestHandler —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–ª `replyTo: { queue: '' }`, RPC —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç –Ω–µ –∑–∞–ø–æ–ª–Ω—è–ª –ø–æ–ª–µ.  
**–†–µ—à–µ–Ω–∏–µ:** RPC —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç –¥–æ–ø–æ–ª–Ω—è–µ—Ç payload –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–º `replyTo` —Å –∏–º–µ–Ω–µ–º —Å–æ–∑–¥–∞–Ω–Ω–æ–π exclusive –æ—á–µ—Ä–µ–¥–∏.

### –ü—Ä–æ–±–ª–µ–º–∞ #2: –ù–µ—Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç—å —Å–∏–≥–Ω–∞—Ç—É—Ä –º–µ—Ç–æ–¥–æ–≤  
**–ü—Ä–æ–±–ª–µ–º–∞:** `setupReplyConsumer()` –ø—Ä–∏–Ω–∏–º–∞–ª `requestId` –∫–∞–∫ –≤—Ç–æ—Ä–æ–π –ø–∞—Ä–∞–º–µ—Ç—Ä, –Ω–æ –≤—ã–∑—ã–≤–∞–ª—Å—è —Å –¥—Ä—É–≥–∏–º–∏ –∞—Ä–≥—É–º–µ–Ω—Ç–∞–º–∏.  
**–†–µ—à–µ–Ω–∏–µ:** –ü—Ä–∏–≤–µ–¥–µ–Ω–∏–µ —Å–∏–≥–Ω–∞—Ç—É—Ä –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ, –ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –ø–µ—Ä–µ–¥–∞—á–∞ `expectedRequestId`.

### –ü—Ä–æ–±–ª–µ–º–∞ #3: –õ–æ–≥–∏–∫–∞ –∫–æ—Ä—Ä–µ–ª—è—Ü–∏–∏ –æ—Ç–≤–µ—Ç–æ–≤
**–ü—Ä–æ–±–ª–µ–º–∞:** `expectedRequestId` –º–æ–≥ –±—ã—Ç—å undefined, —á—Ç–æ –ª–æ–º–∞–ª–æ –∫–æ—Ä—Ä–µ–ª—è—Ü–∏—é –æ—Ç–≤–µ—Ç–æ–≤.  
**–†–µ—à–µ–Ω–∏–µ:** –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ optional –ø–∞—Ä–∞–º–µ—Ç—Ä–∞, –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ requestId –∏–∑ payload.

## –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

### Per-request RPC –∞–ª–≥–æ—Ä–∏—Ç–º:
1. `assertQueue('', { exclusive: true, autoDelete: true })` ‚Üí –ø–æ–ª—É—á–∏—Ç—å –∏–º—è –æ—á–µ—Ä–µ–¥–∏
2. `consume(replyQueue)` —Å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π –ø–æ `requestId`
3. `sendToQueue(requestQueue)` —Å payload —Å–æ–¥–µ—Ä–∂–∞—â–∏–º `replyTo: { queue: replyQueue }`
4. –ü—Ä–∏ –æ—Ç–≤–µ—Ç–µ –∏–ª–∏ timeout: `cancel(consumerTag)` + `deleteQueue(replyQueue)`

### –í—ã–±–æ—Ä –≤–∞—Ä–∏–∞—Ü–∏–π:
- **Image**: –ø–æ –≤—ã—Å–æ—Ç–µ –±–ª–∏–∂–∞–π—à–∞—è –∫ `1080 * scalingFactor`
- **Video preview**: MP4 —Å –±–ª–∏–∂–∞–π—à–µ–π –≤—ã—Å–æ—Ç–æ–π –∏–ª–∏ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π
- **Video order + ProRes**: ProRes ‚Üí MP4 ‚Üí –æ—à–∏–±–∫–∞
- **Fallback**: –ø–µ—Ä–≤–∞—è –¥–æ—Å—Ç—É–ø–Ω–∞—è –≤–∞—Ä–∏–∞—Ü–∏—è

### –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ:
- –í—Å–µ —á–µ—Ä–µ–∑ `winston` —Å OpenTelemetry —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–æ–º
- Debug: –æ—Ç–ø—Ä–∞–≤–∫–∞/–ø–æ–ª—É—á–µ–Ω–∏–µ RPC, –≤—ã–±–æ—Ä –≤–∞—Ä–∏–∞—Ü–∏–π
- Info: —É—Å–ø–µ—à–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏, —Å—Ç–∞—Ç—É—Å—ã –∑–∞–≥—Ä—É–∑–∫–∏
- Error: –æ—à–∏–±–∫–∏ –≤–∞–ª–∏–¥–∞—Ü–∏–∏, network failures, timeouts

### –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫:
- AJV –≤–∞–ª–∏–¥–∞—Ü–∏—è –Ω–∞ –≤—Ö–æ–¥–µ –∏ –≤—ã—Ö–æ–¥–µ
- Network timeout 30s –¥–ª—è HTTP —Å–∫–∞—á–∏–≤–∞–Ω–∏—è  
- MQ timeout –∏–∑ –∫–æ–Ω—Ñ–∏–≥–∞ –¥–ª—è RPC –∑–∞–ø—Ä–æ—Å–æ–≤
- Graceful fallback –ø—Ä–∏ `ams.enabled=false`
- –î–µ—Ç–∞–ª—å–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –≤ error messages

## –†–µ–∑—É–ª—å—Ç–∞—Ç

### ‚úÖ –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã:
- Gateway pattern –∫–∞–∫ –≤ `comfyUI2`/`renderFarm`
- Schema-first —Ç–∏–ø–∏–∑–∞—Ü–∏—è
- –ï–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–∞—è –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
- –ò–∑–æ–ª—è—Ü–∏—è AMQP –¥–µ—Ç–∞–ª–µ–π –æ—Ç –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∏

### ‚úÖ –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å:
- –ó–∞–º–µ–Ω–∞ –≤—Å–µ—Ö –∑–∞–≥–ª—É—à–µ–∫ –Ω–∞ —Ä–∞–±–æ—á—É—é –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é
- Per-request –æ—á–µ—Ä–µ–¥–∏ –±–µ–∑ –≥–æ–Ω–æ–∫
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ image/video —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º –≤—ã–±–æ—Ä–æ–º –≤–∞—Ä–∏–∞—Ü–∏–π
- ProRes –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –¥–ª—è –±—É–¥—É—â–∏—Ö –∑–∞–∫–∞–∑–æ–≤
- –ú–Ω–æ–≥–æ—Ç–µ–Ω–∞–Ω—Ç–Ω–æ—Å—Ç—å —á–µ—Ä–µ–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç

### ‚úÖ –ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å:
- –û–±—è–∑–∞—Ç–µ–ª—å–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ —Ä–µ—Å—É—Ä—Å–æ–≤
- Comprehensive error handling  
- –í–∞–ª–∏–¥–∞—Ü–∏—è –Ω–∞ –≤—Å–µ—Ö —É—Ä–æ–≤–Ω—è—Ö
- –î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è debugging

### ‚úÖ –ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ production:
- –¢–∏–ø–∏–∑–∞—Ü–∏—è –±–µ–∑ –æ—à–∏–±–æ–∫
- –í—Å–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã
- Legacy –∫–æ–¥ —É–¥–∞–ª–µ–Ω
- –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –ø—Ä–∏–Ω—Ü–∏–ø–∞–º –ø—Ä–æ–µ–∫—Ç–∞

**–¢–∏–∫–µ—Ç 603 –≤—ã–ø–æ–ª–Ω–µ–Ω –ø–æ–ª–Ω–æ—Å—Ç—å—é. AMS –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≥–æ—Ç–æ–≤–∞ –∫ –≤–∫–ª—é—á–µ–Ω–∏—é —á–µ—Ä–µ–∑ `ams.enabled=true`.**