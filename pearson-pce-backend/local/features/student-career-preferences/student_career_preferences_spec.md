# Student Career Preferences — Full Spec (v0.1, draft)

## 1) Purpose & Goals (Why this exists)
**Problem:** Our backend computes recommendations (matches), but we do **not** persist the *student’s own ranked choices*. Product & reporting need a reliable record of what a student actually picked — both during "Choose Your Future" (CYF) turns and at the end of the game.

**Goal:** Provide a small, explicit data model + API so UIs can **store** and **read** the student’s ranked career choices, per assessment. This data is **separate from algorithmic matches** and is optimized for reporting.

**Non‑Goals:**
- This feature does **not** change matching logic or scores.
- This feature is **not** about question responses; it’s downstream of them.
- No cross‑assessment profile aggregation in v0.1 (one assessment at a time).

---

## 2) Primary Use Cases (What this enables)
1. **Final ranking capture** at the end of gameplay: UI posts the final ordered list of careers the student selected as favorites/choices.
2. **Reporting view** for teachers/admins: React reporting app loads the stored ranking for a given assessment.
3. **(Optional, future)** Mid‑game snapshots: CYF turns can post interim rankings to the same endpoint (replace‑on‑save semantics keep the latest state).

---

## 3) Data Model (DB Schema)
**Table:** `student_career_preference`

```sql
CREATE TABLE student_career_preference (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  student_assessment_id BIGINT NOT NULL REFERENCES student_assessment(id) ON DELETE CASCADE,
  career_id BIGINT NOT NULL REFERENCES career(id),
  rank INTEGER NOT NULL CHECK (rank >= 1),
  UNIQUE (student_assessment_id, career_id)
);

CREATE INDEX idx_scp_assessment ON student_career_preference(student_assessment_id);
CREATE INDEX idx_scp_assessment_rank ON student_career_preference(student_assessment_id, rank);
```

**Notes:**
- `rank` is a **1‑based** position in the student’s ordered list (1 = top choice).
- Uniqueness per (assessment, career) prevents duplicates; any re‑post uses replace semantics (see below).
- We deliberately **do not** enforce a unique constraint on `(student_assessment_id, rank)` to keep writes simple (we normalize on write). Service enforces that each rank appears once per assessment.

---

## 4) API Endpoints (What & How)

### 4.1 POST /api/student-assessment/{id}/career-preferences
**Summary:** Replace the entire ranked list for an assessment in a single atomic operation.

**Description:**
- Accepts an array of `{ careerId, rank }` pairs.
- Validates careers exist and belong to our catalog.
- Ensures ranks are positive integers and **no duplicates** in the payload.
- On success, **deletes all existing rows** for the assessment and **inserts** the new set in one transaction.
- Idempotent w.r.t. identical payloads.

**Request (JSON):**
```json
[
  { "careerId": 501, "rank": 1 },
  { "careerId": 502, "rank": 2 },
  { "careerId": 503, "rank": 3 }
]
```

**Response:** `204 No Content`

**Errors:**
- `400 validation_error` — malformed body; duplicate ranks/careers; invalid ids; rank < 1.
- `401 unauthorized` — missing/invalid JWT.
- `403 forbidden` — caller cannot modify this assessment -  Insufficient permissions.
- `404 not_found` — assessment does not exist or not visible to caller.


**AuthZ:**
- **Student** may write **own** assessment.
- **Teacher/Admin** may write only if product decides so (default: **no** write; see §7). For v0.1, only student writes.

**Replace‑on‑save Contract:**
- Whole‑list semantics: the provided array becomes the **single source of truth**.
- Empty array `[]` is allowed and means “clear preferences for this assessment”.

---

### 4.2 GET /api/student-assessment/{id}/career-preferences
**Summary:** Return the stored ranked list for an assessment.

**Response (JSON):**
```json
{
  "assessmentId": 2001,
  "preferences": [
    { "careerId": 501, "rank": 1, "careerName": "Civil Engineer" },
    { "careerId": 502, "rank": 2, "careerName": "Software Engineer" },
    { "careerId": 503, "rank": 3, "careerName": "Data Scientist" }
  ]
}
```

**Notes:**
- `careerName` is denormalized for convenience. returning it reduces round‑trips for the React reporting app.

**Errors:** `401/403/404` analogous to POST.

**AuthZ:**
- **Student** can read own assessment.
- **Teacher/Admin** can read assessments for their roster/organization (as per existing access rules).

---

## 5) Validation Rules
- Body must be a JSON **array** of objects: each `{ careerId: number, rank: number }`.
- `rank` must be integer ≥ 1.
- No duplicate `careerId` in payload.
- No duplicate `rank` in payload (service checks and rejects).
- All `careerId` must exist.
- Assessment `{id}` must exist and be visible to caller.

**extra checks (v0.1 decision):**

- Enforce **contiguous ranks** (1..N without gaps). Recommended.

---

## 6) Behavior Details & Edge Cases
- **Idempotency:** Same payload → same DB state → always 204.
- **Partial updates:** Not supported in v0.1. Clients must send the full desired order every time.
- **Concurrency:** Last writer wins. Use standard transaction isolation; detect deadlocks and return `423 locked`.
- **Deletion:** Send `[]` to clear all rankings.
- **Mid‑game vs final:** Endpoint can be called during CYF turns and at final screen. POST overwrites previous state.

---

## 7) Security & Authorization
- JWT (IES) as per the rest of the API.
- Role scoping:
  - Student: write/read own assessment.
  - Teacher: read assessments for their students (no write by default).
  - Admin: read across org; write optional (default off).

### Дополнительно: Проверка studentId в новых career-preferences:

Клиент не передаёт studentId.

Бэкэнд достаёт studentId из JWT (как и в /api/student-assessment v0.4).

При любом POST /api/student-assessment/{id}/career-preferences и GET .../career-preferences мы проверяем:

что student_assessment.id = {id} существует,

что student_assessment.student_id совпадает со studentId из токена (для роли student),